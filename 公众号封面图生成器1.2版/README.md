# 公众号封面图生成器 Chrome 扩展

## 项目简介

这是一个Chrome浏览器扩展，可以自动识别公众号编辑器中的文章标题，并通过调用Coze工作流API生成相应的封面图片。该扩展支持同步和异步工作流执行模式，具备智能错误处理和多平台兼容性。

## 🚀 功能特性

### 核心功能
- **🎯 侧边栏面板**: 点击扩展图标自动在浏览器右侧打开操作面板
- **🔍 智能标题识别**: 自动识别当前页面的文章标题，支持手动输入和多种编辑器平台
- **🤖 AI生成封面**: 基于文章标题调用Coze工作流生成专业封面图，支持同步和异步执行
- **⏱️ 智能等待机制**: 自动轮询工作流状态，支持长时间运行的AI任务
- **🖼️ 图片预览下载**: 实时预览生成的封面图，支持一键下载
- **⚙️ 配置管理**: 本地安全存储API密钥和工作流配置
- **🔧 智能错误处理**: 详细的错误提示和解决建议，包含调试信息
- **🔄 自动重试机制**: 网络错误和临时故障的自动重试
- **📱 跨平台兼容**: 支持多种公众号编辑器和内容管理平台

### 技术特性
- 使用Manifest V3规范
- 响应式设计，适配不同分辨率
- 本地存储用户配置
- 安全的HTTPS API调用
- 完善的错误处理机制

## 项目架构

```
封面图/
├── manifest.json          # 扩展配置文件
├── background.js          # Service Worker后台脚本
├── content.js            # 内容脚本，用于识别标题
├── sidepanel.html        # 侧边栏HTML页面
├── sidepanel.js          # 侧边栏逻辑脚本
├── sidepanel.css         # 侧边栏样式文件
├── popup.html            # 弹窗HTML（可选）
├── popup.js              # 弹窗逻辑脚本（可选）
├── icons/                # 图标文件夹
│   ├── icon16.png
│   ├── icon48.png
│   └── icon128.png
└── README.md             # 项目说明文档
```

## API 集成

### Coze 工作流 API
- **接口地址**：`https://api.coze.cn/v1/workflow/run`
- **请求方法**：POST
- **认证方式**：Bearer Token
- **必需参数**：
  - `workflow_id`：Coze工作流ID
  - `parameters.input`：文章标题文本

### 配置参数
用户需要提供以下配置：
1. **个人令牌**（Personal Token）：用于API认证
2. **工作流ID**（Workflow ID）：指定要调用的Coze工作流

### 技术实现亮点

**🔄 双模式工作流支持**
- 支持Coze工作流的同步和异步执行模式
- 同步模式：直接从响应中提取结果，无需轮询
- 异步模式：智能轮询工作流状态，最多等待60秒
- 每2秒检查一次状态，支持长时间运行的AI任务

**🎯 智能图片URL解析**
- 支持多种API响应格式的图片URL提取
- 递归搜索响应数据中的图片链接
- 自动识别常见图片格式（jpg、png、gif、webp等）
- 支持从data字段、debug_url等多个位置提取图片URL

**🔍 增强的标题识别**
- 支持微信公众平台、秀米、135编辑器等主流平台
- 智能选择器匹配，包含输入框、可编辑元素、标题元素
- 基于置信度的智能识别算法
- 支持ID、class名称、placeholder等多维度匹配

**⚡ 增强的错误处理**
- 详细的错误信息和解决建议
- 区分不同类型的错误（超时、配置、网络、权限等）
- 用户友好的错误提示和操作指导
- 完整的调试日志和错误追踪
- 自动检测受限页面和权限问题

## 使用流程

1. **安装扩展**：将扩展加载到Chrome浏览器
2. **首次配置**：输入Coze API的个人令牌和工作流ID
3. **打开编辑器**：访问公众号编辑器页面
4. **启动扩展**：点击扩展图标打开侧边栏
5. **识别标题**：点击"识别标题"按钮自动获取文章标题
6. **生成封面**：点击"生成封面"按钮调用AI生成图片
7. **预览下载**：查看生成效果并下载图片

## 支持的公众号编辑器

### 完全支持的平台
- **微信公众平台编辑器** (mp.weixin.qq.com)
  - 支持标题输入框识别
  - 支持富文本标题元素
  - 支持桌面版表单输入

- **秀米编辑器** (xiumi.us)
  - 支持标题输入框
  - 支持编辑器标题元素

- **135编辑器** (135editor.com)
  - 支持文章标题输入
  - 支持标题name属性识别

### 通用支持
- 其他主流编辑器（通过通用选择器识别）
- 支持contenteditable元素
- 支持标准HTML标题元素（h1、h2等）
- 支持data-title属性元素

### 智能识别特性
- 基于placeholder文本的智能匹配
- 基于元素ID和class名称的识别
- 多层级置信度评分系统
- 自动过滤无效和过长的标题

## 开发规范

- 遵循Manifest V3规范
- 使用Service Workers替代Background Pages
- 实现最小权限原则
- 添加详细的中文注释
- 完善的错误处理和日志记录
- 响应式UI设计

## 安全考虑

- API密钥本地加密存储
- 所有网络请求使用HTTPS
- 内容脚本权限最小化
- 用户数据不上传到第三方服务器

## 版本信息

- **当前版本**：1.0.0
- **兼容性**：Chrome 88+
- **Manifest版本**：V3

## 更新日志

### v1.0.1 (当前版本)
- **🔧 修复标题提取失败问题**
  - 修复sender.tab未定义导致的TypeError
  - 增强消息通信的错误处理
  - 添加当前活动标签页的自动获取

- **🚀 增强标题识别功能**
  - 扩展输入框选择器支持
  - 新增页面标题元素检测
  - 改进智能识别算法
  - 添加详细的调试日志

- **⚡ 优化工作流执行**
  - 支持Coze工作流同步执行模式
  - 改进executeId提取逻辑
  - 增强图片URL解析能力
  - 优化错误消息显示

- **🛡️ 增强错误处理**
  - 添加受限页面检测
  - 改进网络连接错误提示
  - 提供更友好的用户指导
  - 完善调试信息输出

### v1.0.0 (初始版本)
- 实现基础的标题识别功能
- 集成Coze工作流API
- 添加侧边栏界面
- 支持图片预览和下载
- 实现配置管理功能

## 🔧 故障排除

### 常见问题及解决方案

**1. 标题提取失败**
- 确保在支持的编辑器页面中使用
- 检查页面是否完全加载
- 尝试刷新页面后重新提取
- 查看浏览器控制台的调试信息

**2. 工作流执行失败**
- 检查Coze API令牌是否正确
- 验证工作流ID是否有效
- 确认网络连接正常
- 检查工作流是否正确配置了图片输出

**3. 图标无法显示**
- 重新加载扩展
- 检查图标文件是否存在
- 确认manifest.json配置正确

**4. 侧边栏无法打开**
- 确保不在chrome://等受限页面
- 检查扩展权限设置
- 尝试在普通网页中使用

### 调试模式

开启浏览器开发者工具查看详细日志：
1. 按F12打开开发者工具
2. 切换到Console标签
3. 查看扩展相关的日志信息
4. 根据错误信息进行相应处理

## 🔒 安全和隐私

- **本地存储**：所有配置信息仅存储在本地浏览器中
- **HTTPS通信**：所有API请求均使用安全的HTTPS协议
- **最小权限**：扩展仅请求必要的浏览器权限
- **无数据上传**：用户数据不会上传到第三方服务器
- **API密钥保护**：令牌信息加密存储，不会泄露给其他网站

## 📞 技术支持

如遇到问题，请按以下步骤操作：
1. 查看本文档的故障排除部分
2. 检查浏览器控制台的错误信息
3. 确认扩展版本和浏览器兼容性
4. 提供详细的错误描述和复现步骤